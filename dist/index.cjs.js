"use strict";const g=require("fs"),u=require("path"),k=require("crypto");var l=(e=>(e.png="png",e.jpg="jpg",e.jpeg="jpeg",e.webp="webp",e))(l||{});const b=[];for(const e in l)Object.prototype.hasOwnProperty.call(l,e)&&b.push(l[e]);const m={quality:80,enableDev:!1,enableDevWebp:!1,enableWebP:!0,regExp:`\\.(${b.join("|")})$`,include:b,cacheDir:"node_modules/.cache/vite-plugin-image"},j={};function B(e){j[e]=$(e)}function W(){return j}function D({name:e,type:n,content:t,quality:c,enableWebP:r}){const p=k.createHash("md5").update(t).update(JSON.stringify({quality:c,enableWebP:r})).digest("hex");return`${e}_${p.slice(0,8)}.${n}`}function y(e){return new RegExp(m.regExp).test(e)}function I(e){for(const n in e){const t=e[n];if(!y(n))continue;const{fileName:c}=t,{base:r}=u.parse(c);B(r)}}async function q(e){for(const n in e){const t=e[n],{ext:c}=u.parse(n),{quality:r,enableWebP:p}=m;if(/(js|css|html)$/.test(n)&&p&&(/(js)$/.test(n)?t.code=h(t.code):/(css|html)$/.test(n)&&(t.source=h(t.source))),!!y(n)){if(t.source&&t.source instanceof Buffer){const o=await w(t.source,{type:c,quality:r});t.source=o}if(p){const o=await w(t.source,{type:l.webp,quality:r}),s=$(n),i=structuredClone(t);i.source=o,i.fileName=s,e[s]=i}}}}function h(e){const n=W();let t=e;for(const c in n)t=t.replace(new RegExp(c,"g"),n[c]);return t}function $(e){const[n,t]=e.split("?"),c=u.extname(n),r=e.replace(c,".webp");return t?`${r}?${t}`:r}const C=require("sharp");function E(e){const n=e.includes(".")?e.replace(".",""):e;return n===l.jpg||n===l.jpeg?"jpeg":n}async function w(e,{type:n,quality:t}){const c=E(n);return await C(e).toFormat(c,{quality:t}).toBuffer()}async function F(e,{type:n,quality:t}){if(!y(e))return;const c=g.readFileSync(e),{ext:r}=u.parse(e);return r.replace(".","")===n?c:await w(c,{type:n,quality:t})}async function S(e){const{enableDevWebp:n,quality:t,enableWebP:c,cacheDir:r}=m,{ext:p,name:o}=u.parse(e),s=n?l.webp:p.replace(".",""),i=g.readFileSync(e),f=D({name:o,type:s,content:i,quality:t,enableWebP:c}),a=u.join(r,f);if(g.existsSync(a))return g.readFileSync(a);const d=await F(e,{type:s,quality:t});if(d)return g.writeFile(a,d,()=>{}),d}function P(e={}){e&&!e.regExp&&e.include&&(m.regExp=`\\.(${e.include.join("|")})$`);const{enableDevWebp:n,cacheDir:t,enableDev:c}=Object.assign(m,e);let r=!1;const p=u.resolve(process.cwd(),t);return g.existsSync(p)||g.mkdirSync(p,{recursive:!0}),{name:"vite-plugin-image-tools",config(o,{command:s}){r=s==="build"},configResolved(o){},configureServer(o){c&&o.middlewares.use(async(s,i,f)=>{if(!y(s.url||""))return f();try{const a=decodeURIComponent(u.resolve(process.cwd(),s.url.split("?")[0].slice(1)));y(a)||f();const{ext:d}=u.parse(a),v=n?l.webp:d.replace(".",""),x=await S(a);x||f(),i.setHeader("Content-Type",`image/${v}`),i.end(x)}catch{f()}})},async generateBundle(o,s){r&&(I(s),await q(s))},async writeBundle(o,s){for(const i in s){const f=s[i];if(/(html)$/.test(i)){const a=h(f.source);g.writeFileSync(u.join(o.dir,f.fileName),a)}}}}}module.exports=P;
